{% extends "base.html" %}
{% block title %}Mercados - ConfereApp{% endblock %}

{% block content %}
<div class="container mt-4">
  <h1 class="mb-3">Mercados</h1>

  {% if msg %}
    <div class="alert alert-info">{{ msg }}</div>
  {% endif %}

  <!-- FORM: Novo mercado -->
  <form method="post" class="row g-2 mb-4 bg-dark text-light p-3 rounded">
    <input type="hidden" name="acao" value="novo">

    <div class="col-md-4">
      <label class="form-label">Nome</label>
      <input class="form-control" name="nome" placeholder="Ex.: Supermercado Bom Preço" required>
    </div>

    <div class="col-md-3">
      <label class="form-label">CNPJ</label>
      <input class="form-control" name="cnpj" placeholder="00.000.000/0000-00">
    </div>

    <div class="col-md-5">
      <label class="form-label">E-mail</label>
      <input class="form-control" type="email" name="email" placeholder="contato@mercado.com.br">
    </div>

    <div class="col-md-4">
      <label class="form-label">Logradouro</label>
      <input class="form-control" name="logradouro" placeholder="Rua / Avenida">
    </div>
    <div class="col-md-2">
      <label class="form-label">Número</label>
      <input class="form-control" name="numero" placeholder="123">
    </div>
    <div class="col-md-3">
      <label class="form-label">Bairro</label>
      <input class="form-control" name="bairro" placeholder="Centro">
    </div>
    <div class="col-md-3">
      <label class="form-label">CEP</label>
      <input class="form-control" name="cep" placeholder="00000-000">
    </div>

    <div class="col-md-4">
      <label class="form-label">Cidade</label>
      <input class="form-control" name="cidade" placeholder="Cidade">
    </div>
    <div class="col-md-2">
      <label class="form-label">UF</label>
      <input class="form-control" name="uf" placeholder="PE" maxlength="2">
    </div>

    <!-- NOVO: latitude/longitude opcionais -->
    <div class="col-md-3">
      <label class="form-label">Latitude (opcional)</label>
      <input class="form-control" name="lat" placeholder="-8.01021">
    </div>
    <div class="col-md-3">
      <label class="form-label">Longitude (opcional)</label>
      <input class="form-control" name="lng" placeholder="-36.05540">
    </div>

    <div class="col-md-3 d-flex align-items-end">
      <button class="btn btn-success w-100">Adicionar</button>
    </div>
    <div class="col-md-3 d-flex align-items-end">
      <button class="btn btn-outline-secondary w-100"
              name="acao" value="deduplicar" formnovalidate>
        Deduplicar por CNPJ
      </button>
    </div>
  </form>

  {% if mercados %}
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle table-dark">
        <thead>
          <tr>
            <th>Nome</th>
            <th>CNPJ</th>
            <th>Endereço</th>
            <th>Cidade / UF</th>
            <th>E-mail</th>
            <th>Lat/Lng</th>
            <th style="width:380px">Ações</th>
          </tr>
        </thead>
        <tbody>
        {% for m in mercados %}
          <tr>
            <td>{{ m.nome }}</td>
            <td>{{ m.cnpj or "-" }}</td>
            <td>
              {{ m.logradouro or "" }} {{ m.numero or "" }}
              {% if m.bairro %}, {{ m.bairro }}{% endif %}
              {% if m.cep %} — {{ m.cep }}{% endif %}
            </td>
            <td>{{ m.cidade or "-" }} / {{ m.uf or "-" }}</td>
            <td>{{ m.email or "-" }}</td>
            <td>
              {% if m.lat is not none and m.lng is not none %}
                {{ "%.6f"|format(m.lat) }}, {{ "%.6f"|format(m.lng) }}
              {% else %}
                <span class="text-muted">Sem coordenadas</span>
              {% endif %}
            </td>
            <td class="text-nowrap">

              <!-- Excluir -->
              <form method="post" class="d-inline">
                <input type="hidden" name="acao" value="excluir">
                <input type="hidden" name="id" value="{{ m.id }}">
                <button class="btn btn-sm btn-danger"
                        onclick="return confirm('Excluir o mercado \"{{ m.nome }}\" e seus preços?')">
                  Excluir
                </button>
              </form>

              <!-- Maps / Waze -->
              {% if m.lat is not none and m.lng is not none %}
                <a href="https://www.google.com/maps?q={{ m.lat }},{{ m.lng }}"
                   target="_blank" class="btn btn-sm btn-success ms-1">
                  Maps
                </a>
                <a href="https://waze.com/ul?ll={{ m.lat }},{{ m.lng }}&navigate=yes"
                   target="_blank" class="btn btn-sm btn-info ms-1">
                  Waze
                </a>
              {% else %}
                <span class="badge bg-secondary ms-1">Sem mapa</span>
              {% endif %}

              <!-- Editar (details) -->
              <details class="d-inline-block ms-2">
                <summary class="btn btn-sm btn-outline-light">Editar</summary>
                <form method="post"
                      class="mt-2 p-2 border rounded bg-dark text-light"
                      style="min-width: 720px;">
                  <input type="hidden" name="acao" value="atualizar">
                  <input type="hidden" name="id" value="{{ m.id }}">
                  <div class="row g-2">
                    <div class="col-md-4">
                      <label class="form-label">Nome</label>
                      <input class="form-control" name="nome"
                             value="{{ m.nome }}" placeholder="Nome">
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">CNPJ</label>
                      <input class="form-control" name="cnpj"
                             value="{{ m.cnpj or '' }}" placeholder="CNPJ">
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">E-mail</label>
                      <input class="form-control" type="email" name="email"
                             value="{{ m.email or '' }}" placeholder="E-mail">
                    </div>

                    <div class="col-md-4">
                      <label class="form-label">Logradouro</label>
                      <input class="form-control" name="logradouro"
                             value="{{ m.logradouro or '' }}" placeholder="Logradouro">
                    </div>
                    <div class="col-md-2">
                      <label class="form-label">Número</label>
                      <input class="form-control" name="numero"
                             value="{{ m.numero or '' }}" placeholder="Número">
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Bairro</label>
                      <input class="form-control" name="bairro"
                             value="{{ m.bairro or '' }}" placeholder="Bairro">
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">CEP</label>
                      <input class="form-control" name="cep"
                             value="{{ m.cep or '' }}" placeholder="CEP">
                    </div>

                    <div class="col-md-3">
                      <label class="form-label">Cidade</label>
                      <input class="form-control" name="cidade"
                             value="{{ m.cidade or '' }}" placeholder="Cidade">
                    </div>
                    <div class="col-md-2">
                      <label class="form-label">UF</label>
                      <input class="form-control" name="uf"
                             value="{{ m.uf or '' }}" placeholder="UF" maxlength="2">
                    </div>

                    <!-- NOVO: edição manual das coordenadas -->
                    <div class="col-md-3">
                      <label class="form-label">Latitude</label>
                      <input class="form-control" name="lat"
                             value="{{ m.lat if m.lat is not none else '' }}"
                             placeholder="-8.01021">
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Longitude</label>
                      <input class="form-control" name="lng"
                             value="{{ m.lng if m.lng is not none else '' }}"
                             placeholder="-36.05540">
                    </div>

                    <div class="col-md-3 d-flex align-items-end">
                      <button class="btn btn-primary w-100">Salvar</button>
                    </div>
                  </div>
                </form>
              </details>

            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="text-muted">Nenhum mercado cadastrado.</p>
  {% endif %}
</div>
{% endblock %}
